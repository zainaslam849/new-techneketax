{% extends 'user/master.twig' %}
{% block content %}
    <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
        <!--begin::Toolbar-->
        <div class="toolbar" id="kt_toolbar">
            <!--begin::Container-->
            <div id="kt_toolbar_container" class="container-fluid d-flex flex-stack">
                <!--begin::Page title-->
                <div data-kt-swapper="true" data-kt-swapper-mode="prepend" data-kt-swapper-parent="{default: '#kt_content_container', 'lg': '#kt_toolbar_container'}" class="page-title d-flex align-items-center flex-wrap me-3 mb-5 mb-lg-0">
                    <!--begin::Title-->
                    <h1 class="d-flex text-dark fw-bolder fs-3 align-items-center my-1">{{ plans[0].name }}</h1>
                    <!--end::Title-->
                    <!--begin::Separator-->
                    <span class="h-20px border-gray-300 border-start mx-4"></span>
                    <!--end::Separator-->
                    <!--begin::Breadcrumb-->
                    <ul class="breadcrumb breadcrumb-separatorless fw-bold fs-7 my-1">
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">
                            <a href="/" class="text-muted text-hover-primary">Home</a>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-300 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-muted">Plans</li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item">
                            <span class="bullet bg-gray-300 w-5px h-2px"></span>
                        </li>
                        <!--end::Item-->
                        <!--begin::Item-->
                        <li class="breadcrumb-item text-dark">Checkout</li>
                        <!--end::Item-->
                    </ul>
                    <!--end::Breadcrumb-->
                </div>
            </div>
            <!--end::Container-->
        </div>
        <!--end::Toolbar-->
        <!--begin::Post-->
        <div class="post d-flex flex-column-fluid" id="kt_post">
            <!--begin::Container-->
            <div id="kt_content_container" class="container-xxl">
                <!--begin::Layout-->
                <div class="d-flex flex-column flex-lg-row">
                    <!--begin::Content-->
                    <div class="flex-lg-row-fluid me-lg-15 order-2 order-lg-1 mb-10 mb-lg-0">
                        <!--begin::Card-->
                        <div class="card card-flush pt-3 mb-5 mb-xl-10">
                            <!--begin::Card header-->
                            <div class="card-header">
                                <!--begin::Card title-->
                                <div class="card-title">
                                    <h2 class="fw-bolder">Plan Details</h2>
                                </div>

                            </div>
                            <!--end::Card header-->
                            <!--begin::Card body-->
                            <div class="card-body pt-3">
                                <!--begin::Section-->
                                <div class="mb-10">
                                    <!--begin::Title-->
                                    <h5 class="mb-4">Billing Address:</h5>
                                    <!--end::Title-->
                                    <!--begin::Details-->
                                    <div class="d-flex flex-wrap py-5">
                                        <!--begin::Row-->
                                        <div class="flex-equal me-5">
                                            <!--begin::Details-->
                                            <table class="table fs-6 fw-bold gs-0 gy-2 gx-2 m-0">
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400 min-w-175px w-175px">Bill to:</td>
                                                    <td class="text-gray-800 min-w-200px">
                                                        <a href="mailto:" class="text-gray-800 text-hover-primary">{% if Billing_address[0].billing_email == '' %}Please add Your Billing Address <a href="/user/profile/billing">Add Billing Address</a> {% else %}{{ Billing_address[0].billing_email }}{% endif %}</a>
                                                    </td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400">Customer Name:</td>
                                                    <td class="text-gray-800">{% if Billing_address[0].billing_name == '' %}Please add Your Billing Address <a href="/user/profile/billing">Add Billing Address</a> {% else %}{{ Billing_address[0].billing_name }}{% endif %}</td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400">Address:</td>
                                                    <td class="text-gray-800">{% if Billing_address[0].billing_address == '' %}Please add Your Billing Address <a href="/user/profile/billing">Add Billing Address</a> {% else %}{{ Billing_address[0].billing_address }}{% endif %}</td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400">Phone:</td>
                                                    <td class="text-gray-800">{{ userPhone }}</td>
                                                </tr>
                                                <!--end::Row-->
                                            </table>
                                            <!--end::Details-->
                                        </div>
                                        <!--end::Row-->
                                        <!--begin::Row-->
                                        <div class="flex-equal">
                                            <!--begin::Details-->
                                            <table class="table fs-6 fw-bold gs-0 gy-2 gx-2 m-0">
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400 min-w-175px w-175px">Subscribed Plan:</td>
                                                    <td class="text-gray-800 min-w-200px">
                                                        <a href="#" class="text-gray-800 text-hover-primary">{{ plans[0].name }}</a>
                                                    </td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400">Subscription Fees:</td>
                                                    <td class="text-gray-800">    {% if type == 'month' %}
                                                            ${{ plans[0].monthly_price }}
                                                        {% else %}
                                                            ${{ plans[0].yearly_price }}
                                                        {% endif %} /  {% if type == 'month' %}Mon{% else %}Year{% endif %}</td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <tr>
                                                    <td class="text-gray-400">Billing method:</td>
                                                    <td class="text-gray-800">{% if type == 'month' %}Monthly{% else %}Annually{% endif %}</td>
                                                </tr>
                                                <!--end::Row-->
                                                <!--begin::Row-->
                                                <!--end::Row-->
                                            </table>
                                            <!--end::Details-->
                                        </div>
                                        <!--end::Row-->
                                    </div>
                                    <!--end::Row-->
                                </div>
                                <!--end::Section-->
                                <!--begin::Section-->
                                <div class="mb-0">
                                    <div class="row g-10 bg-light bg-opacity-75 py-15 px-10">
                                        <div class="col-xl-12 text-center">
                                            <h5>Access detailed insights into the permissions associated with this plan, ensuring you have the control and flexibility required.</h5>
                                        </div>
                                        {% for permission in permissions %}
                                            <div class="col-xl-4 col-md-6">
                                                <div class="w-100 mb-5">
                                                    <div class="d-flex align-items-center mb-5">
                                                        <span class="fw-bold fs-6 text-gray-800 flex-grow-1 pe-3">{{ permission[0].title }}</span>
                                                        <!--begin::Svg Icon | path: icons/duotune/general/gen043.svg-->
                                                        <span class="svg-icon svg-icon-1 svg-icon-success">
																		<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
																			<rect opacity="0.3" x="2" y="2" width="20" height="20" rx="10" fill="currentColor" />
																			<path d="M10.4343 12.4343L8.75 10.75C8.33579 10.3358 7.66421 10.3358 7.25 10.75C6.83579 11.1642 6.83579 11.8358 7.25 12.25L10.2929 15.2929C10.6834 15.6834 11.3166 15.6834 11.7071 15.2929L17.25 9.75C17.6642 9.33579 17.6642 8.66421 17.25 8.25C16.8358 7.83579 16.1642 7.83579 15.75 8.25L11.5657 12.4343C11.2533 12.7467 10.7467 12.7467 10.4343 12.4343Z" fill="currentColor" />
																		</svg>
																	</span>
                                                        <!--end::Svg Icon-->
                                                    </div>

                                                </div>
                                            </div>
                                        {% endfor %}
                                        <!--end::Col-->
                                    </div>
                                    <!--end::Product table-->
                                </div>
                                <!--end::Section-->
                            </div>
                            <!--end::Card body-->
                        </div>
                    </div>
                    <!--end::Content-->
                    <!--begin::Sidebar-->
                    <div class="flex-column flex-lg-row-auto w-lg-250px w-xl-300px mb-10 order-1 order-lg-2">
                        <!--begin::Card-->
                        <div class="card card-flush mb-0" data-kt-sticky="true" data-kt-sticky-name="subscription-summary" data-kt-sticky-offset="{default: false, lg: '200px'}" data-kt-sticky-width="{lg: '250px', xl: '300px'}" data-kt-sticky-left="auto" data-kt-sticky-top="150px" data-kt-sticky-animation="false" data-kt-sticky-zindex="95">
                            <!--begin::Card header-->
                            <div class="card-header">
                                <!--begin::Card title-->
                                <div class="card-title">
                                    <h2>Summary</h2>
                                </div>

                            </div>
                            <!--end::Card header-->
                            <!--begin::Card body-->
                            <div class="card-body pt-0 fs-6">
                                <div class="mb-7">
                                    <h5 class="mb-4">Plan details</h5>
                                    <div class="mb-0">
                                        <span class="badge badge-light-info me-2">{{ plans[0].name }}</span>
                                        <!--end::Plan-->
                                        <!--begin::Price-->
                                        <span class="fw-bold text-gray-600">    {% if type == 'month' %}
                                                ${{ plans[0].monthly_price }}
                                            {% else %}
                                                ${{ plans[0].yearly_price }}
                                            {% endif %} /  {% if type == 'month' %}Mon{% else %}Year{% endif %}</span>
                                    </div>
                                </div>
                                <!--end::Section-->
                                <!--begin::Seperator-->
                                <div class="separator separator-dashed mb-7"></div>
                                <div class="mb-10">
                                    <!--begin::Title-->
                                    <h5 class="mb-4">Price Details</h5>
                                    <!--end::Title-->
                                    <!--begin::Details-->
                                    <table class="table fs-6 fw-bold gs-0 gy-2 gx-2">
                                        <!--begin::Row-->
                                        <tr class="">
                                            <td class="text-gray-400">Subtotal:</td>
                                            <td class="text-gray-800">{% if type == 'month' %}
                                                    ${{ plans[0].monthly_price }}
                                                {% else %}
                                                    ${{ plans[0].yearly_price }}
                                                {% endif %}</td>
                                        </tr>
                                        <!--end::Row-->
                                        <!--begin::Row-->
                                        <tr class="">
                                            <td class="text-gray-400">Discount:</td>
                                            <td class="text-gray-800">{{ plans[0].percentage }}%</td>
                                        </tr>
                                        <tr class="">
                                            <td class="text-gray-400">Total Price:</td>
                                            <td class="text-gray-800">${{ totalPrice }}</td>
                                        </tr>
                                        <!--end::Row-->
                                    </table>
                                    <!--end::Details-->
                                </div>
                                <!--end::Section-->
                                <!--begin::Actions-->
                                <div class="mb-0">
                                    <form method="post" id="CheckoutForm">
                                        <input type="hidden" name="user_id" id="user_id" value="{{ loginId }}">
                                        <input type="hidden" name="billing_address_id" id="billing_address_id" value="{{ Billing_address[0].id }}">
                                        <input type="hidden" name="plan_id" id="plan_id" value="{{ plans[0].id }}">
                                        <input type="hidden" name="plan_type" id="plan_type" value="{{ type }}">
                                        <input type="hidden" name="total_price" id="total_price" value="{{ totalPrice }}">
                                        <button type="button"  class="btn btn-primary w-100" id="btn-plan" onclick="plan_checkout()">Checkout</button>
                                    </form>

                                </div>
                                <!--end::Actions-->
                            </div>
                            <!--end::Card body-->
                        </div>
                        <!--end::Card-->
                    </div>
                    <!--end::Sidebar-->
                </div>
                <!--end::Layout-->
            </div>
            <!--end::Container-->
        </div>
        <!--end::Post-->
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        function plan_checkout() {
            var form_Data = new FormData(document.getElementById("CheckoutForm"));
            document.getElementById("btn-plan").innerHTML = "Loading";
            document.getElementById('btn-plan').disabled = true;
            $.ajax({
                url: "/user/plan/checkout",
                type: "POST",
                data: form_Data,
                contentType: false,
                cache: false,
                processData: false,
                success: function (dataResult) {
                    document.getElementById("btn-plan").innerHTML = "Checkout";
                    document.getElementById('btn-plan').disabled = false;
                    console.log(dataResult);

                    if (dataResult == 1) {
                        toastr.success('You Pan Has Been Purchased.');
                        document.getElementById("CheckoutForm").reset();
                    } else if (dataResult == 2) {
                        toastr.error("Please Add Billing Address <a href='/user/profile/billing'>Add Billing Address</a>");
                    } else if (dataResult == 3) {
                        toastr.error("You Already Purchased A plan");
                    } else {
                        toastr.error('Something Went Wrong.');
                    }

                }
            });
        }
    </script>
{% endblock %}