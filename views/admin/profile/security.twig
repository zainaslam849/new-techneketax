{% extends 'admin/master.twig' %}
{% block content %}
    <!--  BEGIN CONTENT AREA  -->
    <div id="content" class="main-content">
        <div class="layout-px-spacing">

            <div class="middle-content container-xxl p-0">

                <!-- BREADCRUMB -->
                <div class="page-meta">
                    <nav class="breadcrumb-style-one" aria-label="breadcrumb">
                        <ol class="breadcrumb">
{#                            <li class="breadcrumb-item"><a href="#">Users</a></li>#}
                            <li class="breadcrumb-item active" aria-current="page">Account Settings</li>
                        </ol>
                    </nav>
                </div>
                <!-- /BREADCRUMB -->

                <div class="account-settings-container layout-top-spacing">

                    <div class="account-content">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h2>Profile</h2>
                                <ul class="nav nav-pills" id="animateLine" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <a class="nav-link"  href="/admin/profile"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>Account Settings</a>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <a class="nav-link active" href="/admin/security"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Security</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                                <div class="row">

                                    <div class="col-xl-12 col-lg-12 col-md-12 layout-spacing">
                                        <div class="section general-info mb-3">
                                            <div class="info">
                                                <form method="post" id="passwordForm">
                                                    <div class="row">
                                                        <h5 class="">Change Password</h5>
                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <label for="current_password">Current Password</label>
                                                                <input type="password" class="form-control mb-3" id="current_password" name="current_password" placeholder="Current Password" >
                                                                <input type="hidden"  id="idForPassword"  value="{{ userinfo.id }}">
                                                                <input type="hidden" name="csrf" value="{{csrf}}">
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="new_password">New Password</label>
                                                                <input type="password" class="form-control mb-3" id="new_password" name="new_password" placeholder="New Password" >
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label for="confirm_password">Confirm Password</label>
                                                                <input type="password" class="form-control mb-3" id="confirm_password" name="confirm_password" placeholder="Confirm Password">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-12 mt-1">
                                                            <div class="form-group text-end">
                                                                <button type="button" class="btn btn-secondary" id="btn-password" onclick="change_password()">Change Password</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="section general-info">
                                            <div class="info">
                                                <h6 class="">Two-factor authentication Settings</h6>
                                                <p>You can on or off 2FA</p>
                                                {% if userinfo.twofa_status == "off" %}
                                                <div class="form-group mt-4">
                                                    <div class="switch form-switch-custom switch-inline form-switch-success mt-1">
                                                        <input class="switch-input" type="checkbox" role="switch"  id="socialformprofile-custom-switch-success" onclick="twofaStatus('{{ userinfo.id }}', 1)">
                                                    </div>
                                                </div>
                                                {% else %}
                                                <div class="form-group mt-4">
                                                    <div class="switch form-switch-custom switch-inline form-switch-success mt-1">
                                                        <input class="switch-input" type="checkbox" role="switch" checked id="socialformprofile-custom-switch-success" onclick="twofaStatus('{{ userinfo.id }}', 0)">
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>




                                </div>

            </div>
                </div>

            </div>   </div>

        <!--  BEGIN FOOTER  -->
        <div class="footer-wrapper">
            <div class="footer-wrapper">
                <div class="footer-section f-section-1">
                    <p class="">Copyright Â© <span class="dynamic-year">2024</span> <a target="_blank" href="https://zotecsoft.com/">ZotecSoft</a>, All rights reserved.</p>
                </div>
            </div>
        </div>
        <!--  END FOOTER  -->

    </div>

    <!--  END CONTENT AREA  -->
    <script>
        function change_password() {
            var id = $("#idForPassword").val();
            var current_password = $("#current_password").val();
            var new_password = $("#new_password").val();
            var confirm_password = $("#confirm_password").val();
            var csrf_token = $("input[name=csrf]").val();

            if (current_password != "" && new_password != "" && confirm_password != "") {
                if ( new_password == confirm_password) {
                    document.getElementById("btn-password").innerHTML = "Loading";
                    $("#btn-password").attr("disabled");
                    $.ajax
                    ({
                        type: 'post',
                        url: '/admin/profile/password_change',
                        data: {
                            do_profile: "do_profile",
                            id: id,
                            current_password: current_password,
                            new_password: new_password,
                            confirm_password: confirm_password,
                            csrf: csrf_token,
                        },
                        success: function (response) {
                            response = $.parseJSON(response);
                            if(response== 1){
                                $("#btn-password").removeAttr("disabled");
                                toastr.success('Update Successfully.');
                                document.getElementById("btn-password").innerHTML = "Change Password";
                            } else if(response==2){
                                toastr.error("Incorrect Current Password");
                                $("#btn-password").removeAttr("disabled");
                            } else{
                                toastr.error('Somthing Went Wrong.');
                                $("#btn-password").removeAttr("disabled");
                            }
                        }
                    });
                }else{
                    document.getElementById("btn-password").innerHTML = "Change Password";
                    document.getElementById("btn-password").disabled = false;
                    toastr.error("Password Doesn't Match ");
                }
            }else{
                document.getElementById("btn-password").innerHTML = "Change Password";
                document.getElementById("btn-password").disabled = false;
                toastr.error("Missing Required Input");

            }
            return false;
        }
        function twofaStatus(userID, status) {

            if(status == 0){
                var currStatus= "off";
            }else{
                var currStatus= "on";
            }
            var el = this;
            $(this).html('<i class="fa fa-circle-o-notch fa-spin"></i> loading...');
            var csrf_token = $("input[name=csrf]").val();
            $.ajax({
                url: '/admin/api',
                type: 'GET', data: {
                    id: userID,
                    status: currStatus,
                    page_name: "userStatusUpdate",
                    table_name:"users",
                    status_table:"twofa_status",
                    csrf: csrf_token
                }, success: function (data) {
                    if (data == 1) {
                        toastr.success('2FA Updated.');
                    } else {
                        toastr.error('Something went wrong.');

                    }
                }

            });
        }

    </script>

{% endblock %}